<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head::head}">
    <meta charset="utf-8">
    <title>用户主页</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
</head>
<body>
<!--header-->
<div th:replace="~{fragments/header::header}"></div>
<!--content-->
<div id="app" style="margin-top: 10%">
    <div class="ui card" style="margin-top: 10%;margin-left: 10%;margin-right: 10%;margin-bottom: 10%;width: 80%;">
        <div class="content">
            <div class="layui-tab layui-tab-card">
                <ul class="layui-tab-title">
                    <li class="layui-this">个人信息</li>
                    <!--<li>权限管理</li>-->
                    <li>更新密码</li>
                </ul>
                <div class="layui-tab-content">
                    <div class="layui-tab-item layui-show">
                        <div id="view"></div>
                        <button class="layui-btn layui-btn-normal" @click="updateUserInfo">更新个人信息</button>
                    </div>
                    <!--<div class="layui-tab-item">
                        <table class="layui-table">
                            <thead>
                            <tr>
                                <th>权限</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr v-for="(item,index) in user.authorities">
                                <td>{{item.name}}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>-->
                    <div class="layui-tab-item">
                        <form class="layui-form" action=""
                              style="margin-left: 10%;margin-right: 10%;width: 80%;">
                            <div class="layui-form-item">
                                <label class="layui-form-label">原密码:</label>
                                <div class="layui-input-block">
                                    <input type="password" name="oldPassword" placeholder="请输入原始密码" autocomplete="off"
                                           class="layui-input"
                                           lay-verify="required|oldPassword">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">新密码:</label>
                                <div class="layui-input-block">
                                    <input type="password" name="password1" placeholder="请输入新密码" autocomplete="off"
                                           class="layui-input"
                                           lay-verify="required|password1">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label">确认新密码:</label>
                                <div class="layui-input-block">
                                    <input type="password" name="password2" placeholder="请确认新密码" autocomplete="off"
                                           class="layui-input"
                                           lay-verify="required|password2">
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-block">
                                    <button class="layui-btn" lay-submit lay-filter="updatePassword">更新密码</button>
                                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <form class="layui-form" id="updateUserInfo" action=""
          style="margin-top: 10%;margin-left: 10%;margin-right: 10%;margin-bottom: 10%;width: 80%;display: none">
        <div class="layui-form-item">
            <label class="layui-form-label">用户名:</label>
            <div class="layui-input-block">
                <input type="text" name="name" placeholder="请输入用户名（20字内）" autocomplete="off" class="layui-input"
                       lay-verify="required|name" :value="user.name">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">手机号:</label>
            <div class="layui-input-block">
                <input type="tel" name="tel" placeholder="请输入手机号" autocomplete="off" class="layui-input"
                       lay-verify="required|phone" :value="user.tel">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">邮箱:</label>
            <div class="layui-input-block">
                <input type="email" name="email" placeholder="请输入邮箱" autocomplete="off" class="layui-input"
                       lay-verify="customEmail" :value="user.email">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">简介:</label>
            <div class="layui-input-block">
                <textarea type="text" name="introduction" placeholder="请输入简介（250字内）" autocomplete="off"
                          class="layui-textarea"
                          lay-verify="introduction" :value="user.introduction"></textarea>
            </div>
        </div>
        <!--单选框在此处使用界面无法点击，而且用选择框可以处理0,1转换问题，但是选择框也无法使用-->
        <div class="layui-form-item">
            <label class="layui-form-label">性别</label>
            <div class="layui-input-block">
                <select name="sex">
                    <option value="0" :selected="user.sex==0">女</option>
                    <option value="1" :selected="user.sex==1">男</option>
                </select>
            </div>
        </div>
        <!--<div class="layui-form-item">
            <label class="layui-form-label">性别0(女),1(男):</label>
            <div class="layui-input-block">
                <input type="text" name="sex" placeholder="请输入性别0(女),1(男)" autocomplete="off" class="layui-input"
                       lay-verify="sex" :value="user.sex">
            </div>
        </div>-->
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="updateSubmit">提交</button>
            </div>
        </div>
    </form>
</div>
<!--footer-->
<div th:replace="~{/fragments/footer::footer}"></div>
</body>
<script id="demo" type="text/html">

    <table class="layui-table">
        <thead>
        <tr>
            <th>用户名</th>
            <th>账号</th>
            <th>手机号</th>
            <th>邮箱</th>
            <th>性别</th>
            <th>简介</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>{{d.name}}</td>
            <td>{{d.username}}</td>
            <td>{{d.tel}}</td>
            <td>{{d.email}}</td>
            <td>{{# if(d.sex==0){ }}
                女
                {{# } else { }}
                男
                {{# } }}
            </td>
            <td>{{d.introduction}}</td>
        </tr>
        </tbody>
    </table>
</script>
<script>
    var app = new Vue({
        el: '#app',
        data: {
            user: {},
            password: {
                oldPassword: "",
                updatePassword: ""
            }
        },
        watch: {
            user: function () {

            }
        },
        methods: {
            loadUserInfo: function (e) {
                $.ajax({
                    url: '/api/user',
                    type: 'get',
                    data: {},
                    async: false,
                    dataType: 'json'
                }).then(function (res) {
                    self.user = res;
                    console.log(self.user)
                }).fail(function () {
                    console.log('request userinfo fail');
                });
            },
            updateUserInfo: function (e) {
                var self = this;
                var csrfToken = $("meta[name='_csrf']").attr("content");
                var csrfHeader = $("meta[name='_csrf_header']").attr("content");
                layui.use(["form"], function () {
                    var form = layui.form
                    var index = layer.open({
                        type: 1,
                        title: '更新用户信息',
                        //定义宽度
                        area: '50%',
                        offset: 'auto',
                        content: $('#updateUserInfo'),
                        success: function (layero, index) {
                            $("#updateUserInfo").css("display", "block");
                            //不渲染无法使用，单选框点击不动
                            form.render();
                            //console.log(self.user);
                            form.on('submit(updateSubmit)', function (e) {
                                var data = {}
                                data.name = $("input[name='name']").val();
                                data.tel = $("input[name='tel']").val();
                                data.email = $("input[name='email']").val();
                                data.sex = $("select option:checked").val();
                                data.introduction = $("textarea[name='introduction']").val();
                                //console.log(data);
                                $.ajax({
                                    url: '/api/user/' + self.user.id,
                                    type: 'put',
                                    data: JSON.stringify(data),
                                    beforeSend: function (request) {
                                        request.setRequestHeader(csrfHeader, csrfToken); // 添加CSRF Token
                                    },
                                    contentType: 'application/json',
                                    success: function (res) {
                                        layui.use('layer', function () {
                                            var layer = layui.layer;
                                            layer.msg('更新用户信息成功', {offset: 'lb'});
                                        });
                                        //todo 可以只更新vue数据，现在为了节省时间，重载页面
                                        location.reload();
                                        layer.close(index);
                                    },
                                    fail: function (res) {
                                        layui.use('layer', function () {
                                            var layer = layui.layer;
                                            layer.msg('更新用户信息失败', {offset: 'lb'});
                                        });
                                    }
                                })
                            });

                        }, cancel: function () {
                            //右上角关闭回调
                            $("#updateUserInfo").css("display", "none");
                            //return false 开启该代码可禁止点击该按钮关闭
                        }
                    });
                });
            }
        },
        created: function () {
            self = this;
            var csrfToken = $("meta[name='_csrf']").attr("content");
            var csrfHeader = $("meta[name='_csrf_header']").attr("content");
            //加载用户信息
            $.ajax({
                url: '/api/user',
                type: 'get',
                data: {},
                async: false,
                dataType: 'json'
            }).then(function (res) {
                self.user = res;
                console.log(self.user)
                layui.use(['form', 'element', 'laytpl'], function () {
                    var form = layui.form
                        , layer = layui.layer,
                        laytpl = layui.laytpl;
                    //渲染模板引擎
                    var data = { //数据
                        "name": self.user.name,
                        "username": self.user.username,
                        "tel": self.user.tel,
                        "email": self.user.email,
                        "sex": self.user.sex,
                        "introduction": self.user.introduction
                    }
                    //console.log(self.user)
                    //console.log(data)
                    var getTpl = demo.innerHTML
                        , view = document.getElementById('view');
                    laytpl(getTpl).render(data, function (html) {
                        view.innerHTML = html;
                    });

                    var password;
                    //字面量正则
                    var emailRe = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
                    //自定义验证规则
                    form.verify({
                        oldPassword: function (value) {
                            self.password.oldPassword = value;
                        },
                        password1: function (value) {
                            password = value;
                        },
                        sex: function (value) {
                            if ("0" != value && "1" != value) {
                                return "性别只能为0(女),1(男)"
                            }
                        },
                        password2: function (value) {
                            if (password != value) {
                                return "两次输入密码不一致"
                            }
                            self.password.updatePassword = value;
                        },
                        introduction: function (value) {
                            if (value.length > 250) {
                                return "简介长度在250字节内"
                            }
                        },
                        name: function (value) {
                            if (value.length > 20) {
                                return "用户名在20字节内"
                            }
                        },
                        customEmail: function (value) {
                            if (value.length > 0 && !emailRe.test(value)) {
                                return "邮箱格式不正确"
                            }
                        },
                    });

                    form.on('submit(updatePassword)', function (data) {
                        $.ajax({
                            url: '/api/user/updatePassword',
                            type: 'put',
                            contentType: 'application/json',
                            data: JSON.stringify(self.password),
                            beforeSend: function (request) {
                                request.setRequestHeader(csrfHeader, csrfToken); // 添加CSRF Token
                            },
                            dataType: 'json'
                        }).then(function (res) {
                            layui.use('layer', function () {
                                var layer = layui.layer;
                                if (res) {
                                    layer.msg('更新密码成功', {offset: 'lb'});
                                    //csrf 不能用get
                                    //window.location.href = "/logout"
                                    setTimeout(function () {
                                        window.location.href = "/login";
                                    }, 500)
                                } else {
                                    layer.msg('原始密码错误', {offset: 'lb'});
                                }
                            });
                        }).fail(function () {
                            console.log('request fail');
                            layui.use('layer', function () {
                                var layer = layui.layer;
                                layer.msg('更新密码失败', {offset: 'lb'});
                            });
                        });
                        return false;
                    });
                });
            }).fail(function () {
                console.log('request userinfo fail');
            });
        }
    });
</script>
</html>